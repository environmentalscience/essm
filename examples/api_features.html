
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Use examples &#8212; ESSM 0.4.3.dev1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Docs" href="../api.html" />
    <link rel="prev" title="Importable variables and equations" href="importable_variables_equations.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Use-examples">
<h1>Use examples<a class="headerlink" href="#Use-examples" title="Permalink to this headline">¶</a></h1>
<p>This jupyter notebook can be found at: <a class="reference external" href="https://github.com/environmentalscience/essm/blob/master/docs/examples/api_features.ipynb">https://github.com/environmentalscience/essm/blob/master/docs/examples/api_features.ipynb</a></p>
<p>Below, we will import some generic python packages that are used in this notebook:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Checking for essm version installed</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="n">pkg_resources</span><span class="o">.</span><span class="n">get_distribution</span><span class="p">(</span><span class="s2">&quot;essm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;0.4.2.dev5+dirty&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;style&gt;.container { width:120% !important; }&lt;/style&gt;&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>.container { width:120% !important; }</style></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">init_printing</span><span class="p">,</span> <span class="n">latex</span>
<span class="n">init_printing</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">sympy.printing</span> <span class="kn">import</span> <span class="n">StrPrinter</span>
<span class="n">StrPrinter</span><span class="o">.</span><span class="n">_print_Quantity</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">abbrev</span><span class="p">)</span>    <span class="c1"># displays short units (m instead of meter)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="c1"># Import various functions from sympy</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Derivative</span><span class="p">,</span> <span class="n">Eq</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">solve</span><span class="p">,</span> <span class="n">Symbol</span>
<span class="kn">from</span> <span class="nn">essm.equations</span> <span class="kn">import</span> <span class="n">Equation</span>
<span class="kn">from</span> <span class="nn">essm.variables</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">essm.variables.utils</span> <span class="kn">import</span> <span class="n">ListTable</span><span class="p">,</span> <span class="n">generate_metadata_table</span>
</pre></div>
</div>
</div>
<div class="section" id="Importing-variables-and-equations-from-essm">
<h2>Importing variables and equations from essm<a class="headerlink" href="#Importing-variables-and-equations-from-essm" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">essm.variables.chamber</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">essm.variables.leaf</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">essm.variables.physics.thermodynamics</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">essm.equations.leaf</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">essm.equations.physics.thermodynamics</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Plotting">
<h2>Plotting<a class="headerlink" href="#Plotting" title="Permalink to this headline">¶</a></h2>
<p>Below, we will define a function to make plotting of equations very easy, and then show an example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">latex</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">N</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">arange</span>
<span class="kn">from</span> <span class="nn">essm.variables.units</span> <span class="kn">import</span> <span class="n">derive_unit</span><span class="p">,</span> <span class="n">SI</span><span class="p">,</span> <span class="n">Quantity</span>
<span class="kn">from</span> <span class="nn">essm.variables.utils</span> <span class="kn">import</span> <span class="n">markdown</span>

<span class="k">def</span> <span class="nf">plot_expr2</span><span class="p">(</span><span class="n">xvar_min_max</span><span class="p">,</span> <span class="n">yldata</span><span class="p">,</span> <span class="n">yllabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yrdata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">yrlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">clf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ylmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">yrmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yrmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">loc_legend_left</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">loc_legend_right</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
               <span class="n">linestylesl</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">],</span>
               <span class="n">linestylesr</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">],</span>
               <span class="n">fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize_ticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">fontsize_legend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">fig1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot expressions as function of xvar from xmin to xmax.</span>

<span class="sd">    **Examples:**</span>

<span class="sd">    from essm.variables import Variable</span>
<span class="sd">    from essm.variables.physics.thermodynamics import T_a</span>
<span class="sd">    from essm.equations.physics.thermodynamics import eq_nua, eq_ka</span>
<span class="sd">    vdict = Variable.__defaults__.copy()</span>
<span class="sd">    expr = eq_nua.subs(vdict)</span>
<span class="sd">    exprr = eq_ka.subs(vdict)</span>
<span class="sd">    xvar = T_a</span>
<span class="sd">    yldata = [(expr.rhs, &#39;full&#39;), (expr.rhs/2, &#39;half&#39;)]</span>
<span class="sd">    yrdata = exprr</span>
<span class="sd">    plot_expr2((T_a, 273, 373), yldata, yllabel = (nu_a), yrdata=yrdata)</span>
<span class="sd">    plot_expr2((T_a, 273, 373), yldata, yllabel = (nu_a),</span>
<span class="sd">               yrdata=[(1/exprr.lhs, 1/exprr.rhs)],</span>
<span class="sd">               loc_legend_right=&#39;lower right&#39;)</span>
<span class="sd">    plot_expr2((T_a, 273, 373), expr)</span>
<span class="sd">    plot_expr2((T_a, 273, 373), yldata, yllabel = (nu_a))</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">xvar</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">=</span> <span class="n">xvar_min_max</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">colors</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">yrdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fontsize</span><span class="p">:</span>
        <span class="n">fontsize_labels</span> <span class="o">=</span> <span class="n">fontsize</span>
        <span class="n">fontsize_legend</span> <span class="o">=</span> <span class="n">fontsize</span>
        <span class="n">fontsize_ticks</span> <span class="o">=</span> <span class="n">fontsize</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fig1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">fig1</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xvar</span><span class="p">,</span> <span class="s1">&#39;definition&#39;</span><span class="p">):</span>
        <span class="n">unit1</span> <span class="o">=</span> <span class="n">derive_unit</span><span class="p">(</span><span class="n">xvar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unit1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">strunit</span> <span class="o">=</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">markdown</span><span class="p">(</span><span class="n">unit1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strunit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xlabel</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span><span class="o">+</span><span class="n">latex</span><span class="p">(</span><span class="n">xvar</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="o">+</span> <span class="n">strunit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xlabel</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="n">xvar</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">yldata</span><span class="p">,</span> <span class="s1">&#39;lhs&#39;</span><span class="p">):</span>
        <span class="n">yldata</span> <span class="o">=</span> <span class="p">(</span><span class="n">yldata</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">yldata</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">yllabel</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">yldata</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">yllabel</span> <span class="o">=</span> <span class="n">yldata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">yllabel</span> <span class="o">=</span> <span class="n">yldata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;yldata must be equation or list of (expr, name) tuples&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">yllabel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">unit1</span> <span class="o">=</span> <span class="n">derive_unit</span><span class="p">(</span><span class="n">yllabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unit1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">strunit</span> <span class="o">=</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">markdown</span><span class="p">(</span><span class="n">unit1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strunit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">yllabel</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span><span class="o">+</span><span class="n">latex</span><span class="p">(</span><span class="n">yllabel</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="o">+</span> <span class="n">strunit</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="p">(</span><span class="n">yldata</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">yldata</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="c1"># If only an expression given</span>
        <span class="n">yldata</span> <span class="o">=</span> <span class="p">[(</span><span class="n">yldata</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">yldata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">yldata</span> <span class="o">=</span> <span class="p">[</span><span class="n">yldata</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">yrdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">yrlabel</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">yrdata</span><span class="p">,</span> <span class="s1">&#39;lhs&#39;</span><span class="p">):</span>
                <span class="n">yrlabel</span> <span class="o">=</span> <span class="n">yrdata</span><span class="o">.</span><span class="n">lhs</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="p">(</span><span class="n">yrdata</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">yrdata</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="c1"># If only an expression given</span>
            <span class="n">yrdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">yrdata</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">yrlabel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">yrlabel</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span><span class="o">+</span><span class="n">latex</span><span class="p">(</span><span class="n">yrlabel</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">markdown</span><span class="p">(</span><span class="n">derive_unit</span><span class="p">(</span><span class="n">yrlabel</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

    <span class="n">xstep</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">npoints</span>
    <span class="n">xvals</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xstep</span><span class="p">)</span>

    <span class="n">ax1</span> <span class="o">=</span>  <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yrdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
    <span class="k">if</span> <span class="n">ylmin</span><span class="p">:</span>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ylmin</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ylmax</span><span class="p">:</span>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymax</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ylmax</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">yllabel</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">expr1</span><span class="p">,</span> <span class="n">y1var</span><span class="p">)</span> <span class="ow">in</span> <span class="n">yldata</span><span class="p">:</span>
        <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestylesl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">yrdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span><span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">y1vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">expr1</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xvar</span><span class="p">,</span> <span class="n">dummy</span><span class="p">)</span><span class="o">.</span><span class="n">n</span><span class="p">()</span> <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="n">xvals</span><span class="p">]</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">y1vals</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y1var</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">([</span><span class="n">expr1</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xvar</span><span class="p">,</span> <span class="n">dummy</span><span class="p">)</span> <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="n">xvals</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">yrdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc_legend_left</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize_legend</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">yrdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># instantiate a second axes that shares the same x-axis</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">yrlabel</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">yrdata</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>   <span class="c1"># if item is tuple</span>
                <span class="p">(</span><span class="n">expr2</span><span class="p">,</span> <span class="n">y2var</span><span class="p">)</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">y2var</span><span class="p">,</span> <span class="n">expr2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">lhs</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;yrdata must be a list of equations or tuples (var, expr)&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestylesr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">y2vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">expr2</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xvar</span><span class="p">,</span> <span class="n">dummy</span><span class="p">)</span><span class="o">.</span><span class="n">n</span><span class="p">()</span> <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="n">xvals</span><span class="p">]</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">y2vals</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y2var</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">expr2</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">([</span><span class="n">expr2</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">xvar</span><span class="p">,</span> <span class="n">dummy</span><span class="p">)</span><span class="o">.</span><span class="n">n</span><span class="p">()</span> <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="n">xvals</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">yrlabel</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">yrdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;lhs&#39;</span><span class="p">):</span>
                    <span class="n">yrlabel</span> <span class="o">=</span> <span class="n">yrdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lhs</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">yrlabel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">yrlabel</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span><span class="o">+</span><span class="n">latex</span><span class="p">(</span><span class="n">yrlabel</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">markdown</span><span class="p">(</span><span class="n">derive_unit</span><span class="p">(</span><span class="n">yrlabel</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yrmin</span><span class="p">:</span>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">yrmin</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">yrmax</span><span class="p">:</span>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymax</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">yrmax</span><span class="p">))</span>
        <span class="n">leg</span><span class="o">=</span><span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc_legend_right</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize_legend</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">leg</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">([</span><span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="p">]):</span>
            <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize_labels</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize_ticks</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">([</span><span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="p">]):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize_labels</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize_ticks</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># otherwise the right y-label is slightly clipped</span>
    <span class="k">return</span> <span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">vdict</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">eq_nua</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">vdict</span><span class="p">)</span>
<span class="n">exprr</span> <span class="o">=</span> <span class="n">eq_ka</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">vdict</span><span class="p">)</span>
<span class="n">xvar</span> <span class="o">=</span> <span class="n">T_a</span>
<span class="n">yldata</span> <span class="o">=</span> <span class="p">[(</span><span class="n">expr</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">rhs</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;half&#39;</span><span class="p">)]</span>
<span class="n">yrdata</span> <span class="o">=</span> <span class="n">exprr</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plot_expr2</span><span class="p">((</span><span class="n">T_a</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">373</span><span class="p">),</span> <span class="n">yldata</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">yrdata</span><span class="o">=</span><span class="n">exprr</span><span class="p">,</span> <span class="n">yrmin</span><span class="o">=-</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span> <span class="c1"># note that yrmin=0 would have no effect</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plot_expr2</span><span class="p">((</span><span class="n">T_a</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">373</span><span class="p">),</span> <span class="n">yldata</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">yrdata</span><span class="o">=</span><span class="n">exprr</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">],</span> <span class="n">linestylesr</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;--&#39;</span><span class="p">])</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plot_expr2</span><span class="p">((</span><span class="n">T_a</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">373</span><span class="p">),</span> <span class="n">yldata</span><span class="p">,</span> <span class="n">yllabel</span> <span class="o">=</span> <span class="p">(</span><span class="n">nu_a</span><span class="p">),</span> <span class="n">yrdata</span><span class="o">=</span><span class="n">yrdata</span><span class="p">)</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plot_expr2</span><span class="p">((</span><span class="n">T_a</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">373</span><span class="p">),</span> <span class="n">yldata</span><span class="p">,</span> <span class="n">yllabel</span> <span class="o">=</span> <span class="p">(</span><span class="n">nu_a</span><span class="p">),</span> <span class="n">yrdata</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="o">/</span><span class="n">exprr</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">exprr</span><span class="o">.</span><span class="n">lhs</span><span class="p">)],</span>
           <span class="n">loc_legend_right</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plot_expr2</span><span class="p">((</span><span class="n">T_a</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">373</span><span class="p">),</span> <span class="n">expr</span><span class="p">)</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plot_expr2</span><span class="p">((</span><span class="n">T_a</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">373</span><span class="p">),</span> <span class="n">yldata</span><span class="p">,</span> <span class="n">yllabel</span> <span class="o">=</span> <span class="p">(</span><span class="n">nu_a</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_api_features_9_0.png" src="../_images/examples_api_features_9_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_api_features_9_1.png" src="../_images/examples_api_features_9_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_api_features_9_2.png" src="../_images/examples_api_features_9_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_api_features_9_3.png" src="../_images/examples_api_features_9_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_api_features_9_4.png" src="../_images/examples_api_features_9_4.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_api_features_9_5.png" src="../_images/examples_api_features_9_5.png" />
</div>
</div>
<p>We can also manipulate the figure later, e.g. change the width:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_api_features_11_0.png" src="../_images/examples_api_features_11_0.png" />
</div>
</div>
</div>
<div class="section" id="Creating-new-variables">
<h2>Creating new variables<a class="headerlink" href="#Creating-new-variables" title="Permalink to this headline">¶</a></h2>
<p>To create custom variables, first import <code class="docutils literal notranslate"><span class="pre">Variable</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">essm.variables</span> <span class="kn">import</span> <span class="n">Variable</span>
</pre></div>
</div>
</div>
<p>To define units, you can either import these units from the library, e.g.</p>
<p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">essm.variables.units</span> <span class="pre">import</span> <span class="pre">joule,</span> <span class="pre">kelvin,</span> <span class="pre">meter</span></code></p>
<p>or import the appropriate units from sympy, e.g.</p>
<p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">sympy.physics.units</span> <span class="pre">import</span> <span class="pre">joule,</span> <span class="pre">kelvin,</span> <span class="pre">meter</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy.physics.units</span> <span class="kn">import</span> <span class="n">joule</span><span class="p">,</span> <span class="n">kelvin</span><span class="p">,</span> <span class="n">meter</span><span class="p">,</span> <span class="n">mole</span><span class="p">,</span> <span class="n">pascal</span><span class="p">,</span> <span class="n">second</span>
</pre></div>
</div>
</div>
<p>Then you can define a custom variable with its name, description, domain, latex_name, unit, and an optional default value, e.g.:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">R_mol</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Molar gas constant.&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">joule</span><span class="o">/</span><span class="p">(</span><span class="n">kelvin</span><span class="o">*</span><span class="n">mole</span><span class="p">)</span>
    <span class="n">latex_name</span> <span class="o">=</span> <span class="s1">&#39;R_</span><span class="si">{mol}</span><span class="s1">&#39;</span>
    <span class="n">default</span> <span class="o">=</span> <span class="mf">8.314472</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:R_mol&#34; will be overridden by &#34;__main__:&lt;class &#39;__main__.R_mol&#39;&gt;&#34;
  instance[expr] = instance
</pre></div></div>
</div>
<p>The variables defined above hold information about their docstring, units, latex representations and default values if any. Each can be accessed by e.g.:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">R_mol</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">R_mol</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">R_mol</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">latex_name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">R_mol</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Molar gas constant.
J/(K*mol)
R_{mol}
8.314472
</pre></div></div>
</div>
<p>We will now define a few additional variables.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">P_g</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pressure of gas.&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">pascal</span>

<span class="k">class</span> <span class="nc">V_g</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Volume of gas.&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">meter</span><span class="o">**</span><span class="mi">3</span>

<span class="k">class</span> <span class="nc">n_g</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Amount of gas.&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">mole</span>

<span class="k">class</span> <span class="nc">n_w</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Amount of water.&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">mole</span>

<span class="k">class</span> <span class="nc">T_g</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Temperature of gas.&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">kelvin</span>

<span class="k">class</span> <span class="nc">P_wa</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Partial pressure of water vapour in air.&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">pascal</span>
    <span class="n">latex_name</span> <span class="o">=</span> <span class="s1">&#39;P_</span><span class="si">{wa}</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:P_wa&#34; will be overridden by &#34;__main__:&lt;class &#39;__main__.P_wa&#39;&gt;&#34;
  instance[expr] = instance
</pre></div></div>
</div>
<div class="section" id="Variables-with-expressions-as-definitions">
<h3>Variables with expressions as definitions<a class="headerlink" href="#Variables-with-expressions-as-definitions" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">Delta_Pwa</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Slope of saturated vapour pressure, $\partial P_{wa} / \partial T_g$&quot;&quot;&quot;</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">Derivative</span><span class="p">(</span><span class="n">P_wa</span><span class="p">,</span><span class="n">T_g</span><span class="p">)</span>
    <span class="n">latex_name</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\Delta&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Delta_Pwa</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">unit</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$\frac{Pa}{K}$$</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Delta_Pwa</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">expr</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$\frac{d}{d T_g} P_{wa}$$</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">generate_metadata_table</span><span class="p">([</span><span class="n">Delta_Pwa</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<table><tr><td>Symbol</td><td>Name</td><td>Description</td><td>Definition</td><td>Default value</td><td>Units</td></tr><tr><td>$\Delta$</td><td>Delta_Pwa</td><td>Slope of saturated vapour pressure, $\partial P_{wa} / \partial T_g$</td><td>$\frac{d}{d T_g} P_{wa}$</td><td>-</td><td>Pa K$^{-1}$</td></tr></table></div>
</div>
</div>
<div class="section" id="Linking-assumptions-to-variables">
<h3>Linking assumptions to variables<a class="headerlink" href="#Linking-assumptions-to-variables" title="Permalink to this headline">¶</a></h3>
<p>We can specify if a given variable is a complex, real, integer etc. by using the <code class="docutils literal notranslate"><span class="pre">assumptions</span></code> property during variable definition:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">x</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;Positive real variable.&quot;&quot;&quot;</span>
     <span class="n">assumptions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;positive&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="n">solve</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1]
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Creating-new-equations">
<h2>Creating new equations<a class="headerlink" href="#Creating-new-equations" title="Permalink to this headline">¶</a></h2>
<p>Equations have a left hand side and a right hand side and if they contain variables with units, the units of each addend must be the same.</p>
<div class="section" id="Custom-equation">
<h3>Custom equation<a class="headerlink" href="#Custom-equation" title="Permalink to this headline">¶</a></h3>
<p>To create custom equations, first import <code class="docutils literal notranslate"><span class="pre">Equation</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">essm.equations</span> <span class="kn">import</span> <span class="n">Equation</span>
</pre></div>
</div>
</div>
<p>We will now define an equation representing the ideal gas law, based on the variables defined above:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">eq_ideal_gas_law</span><span class="p">(</span><span class="n">Equation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ideal gas law.&quot;&quot;&quot;</span>

    <span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_g</span><span class="o">*</span><span class="n">V_g</span><span class="p">,</span> <span class="n">n_g</span><span class="o">*</span><span class="n">R_mol</span><span class="o">*</span><span class="n">T_g</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note that whenever an equation is defined, its units are checked for consistency in the background and if they are not consistent, an error message will be printed. To illustrate this, we will try to define the above equation again, but omit temperature on the right hand side:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">eq_ideal_gas_law</span><span class="p">(</span><span class="n">Equation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ideal gas law.&quot;&quot;&quot;</span>

        <span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_g</span><span class="o">*</span><span class="n">V_g</span><span class="p">,</span> <span class="n">n_g</span><span class="o">*</span><span class="n">R_mol</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">exc1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dimension of &#34;R_mol*n_g&#34; is Dimension(length**2*mass/(temperature*time**2)), but it should be the same as P_g*V_g, i.e. Dimension(length**2*mass/time**2)
</pre></div></div>
</div>
<p>The equation can be displayed in typesetted form, and the documentation string can be accessed in a similar way as for Variable:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">display</span><span class="p">(</span><span class="n">eq_ideal_gas_law</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">eq_ideal_gas_law</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_g V_g = R_{mol} T_g n_g$$</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Ideal gas law.
</pre></div></div>
</div>
</div>
<div class="section" id="New-equation-based-on-manipulation-of-previous-equations">
<h3>New equation based on manipulation of previous equations<a class="headerlink" href="#New-equation-based-on-manipulation-of-previous-equations" title="Permalink to this headline">¶</a></h3>
<p>We can use the above equation just as any Sympy expression, and e.g. solve it for pressure:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">soln</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">eq_ideal_gas_law</span><span class="p">,</span> <span class="n">P_g</span><span class="p">,</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="nb">print</span><span class="p">(</span><span class="n">soln</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{P_g: R_mol*T_g*n_g/V_g}]
</pre></div></div>
</div>
<p>If we want to define a new equation based on a manipulation of eq_ideal_gas_law we can specify that the parent of the new equation is <code class="docutils literal notranslate"><span class="pre">eq_ideal_gas_law.definition</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">eq_Pg</span><span class="p">(</span><span class="n">eq_ideal_gas_law</span><span class="o">.</span><span class="n">definition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate pressure of ideal gas.&quot;&quot;&quot;</span>

    <span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_g</span><span class="p">,</span> <span class="n">soln</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">P_g</span><span class="p">])</span>
<span class="n">eq_Pg</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_g = \frac{R_{mol} T_g n_g}{V_g}$$</div></div>
</div>
<p>We can also have nested inheritance, if we now define another equation based on eq_Pg:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">eq_Pwa_nw</span><span class="p">(</span><span class="n">eq_Pg</span><span class="o">.</span><span class="n">definition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate vapour pressure from amount of water in gas.&quot;&quot;&quot;</span>

    <span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_wa</span><span class="p">,</span> <span class="n">eq_Pg</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">n_g</span><span class="p">,</span> <span class="n">n_w</span><span class="p">))</span>
<span class="n">eq_Pwa_nw</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_{wa} = \frac{R_{mol} T_g n_w}{V_g}$$</div></div>
</div>
</div>
<div class="section" id="Show-inheritance-of-equations">
<h3>Show inheritance of equations<a class="headerlink" href="#Show-inheritance-of-equations" title="Permalink to this headline">¶</a></h3>
<p>To see the inheritance (what other equations it depends on) of the newly created equation:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">eq_Pwa_nw</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="vm">__bases__</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(__main__.eq_Pg,)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">eq_Pwa_nw</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;eq_Pg&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">expr</span> <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">eq_Pwa_nw</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$\left [ P_g = \frac{R_{mol} T_g n_g}{V_g}\right ]$$</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_parents</span><span class="p">(</span><span class="n">equation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return set of recursive parents of equation.&quot;&quot;&quot;</span>
    <span class="n">allparents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">parents</span> <span class="o">=</span> <span class="n">equation</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="vm">__bases__</span>
    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">allparents</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">allparents</span>
<span class="n">get_parents</span><span class="p">(</span><span class="n">eq_Pwa_nw</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;eq_Pg&#39;}
</pre></div></div>
</div>
<p>We can also write a function to get all parents recursively:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_allparents</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">allparents</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return set of recursive parents of equation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allparents</span><span class="p">:</span>
        <span class="n">allparents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">parents</span> <span class="o">=</span> <span class="n">equation</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="vm">__bases__</span>
    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">allparents</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
            <span class="n">get_allparents</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">allparents</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">allparents</span>
<span class="n">get_allparents</span><span class="p">(</span><span class="n">eq_Pwa_nw</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;eq_Pg&#39;, &#39;eq_ideal_gas_law&#39;}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">get_allparents</span><span class="p">(</span><span class="n">eq_Pg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;eq_ideal_gas_law&#39;}
</pre></div></div>
</div>
</div>
<div class="section" id="Computational-burden-of-deriving-equations-within-class-definition">
<h3>Computational burden of deriving equations within class definition<a class="headerlink" href="#Computational-burden-of-deriving-equations-within-class-definition" title="Permalink to this headline">¶</a></h3>
<p>If we solve for a variable to derive a new equation, is the solve() command performed every time this equation is used?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">eq_Pg1</span><span class="p">(</span><span class="n">eq_ideal_gas_law</span><span class="o">.</span><span class="n">definition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate pressure of ideal gas.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">solve</span>
    <span class="n">soln</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">eq_ideal_gas_law</span><span class="p">,</span> <span class="n">P_g</span><span class="p">,</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="nb">print</span><span class="p">(</span><span class="n">soln</span><span class="p">)</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_g</span><span class="p">,</span> <span class="n">soln</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">P_g</span><span class="p">])</span>
<span class="n">eq_Pg1</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{P_g: R_mol*T_g*n_g/V_g}]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;__main__:eq_Pg&#34; will be overridden by &#34;__main__:&lt;class &#39;__main__.eq_Pg1&#39;&gt;&#34;
  instance[expr] = instance
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_g = \frac{R_{mol} T_g n_g}{V_g}$$</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">time</span>
<span class="n">eq_Pg</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">R_mol</span><span class="p">:</span> <span class="mf">8.314</span><span class="p">,</span> <span class="n">T_g</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="n">n_g</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">V_g</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 2 µs, sys: 1 µs, total: 3 µs
Wall time: 7.15 µs
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_g = 249.42$$</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">time</span>
<span class="n">eq_Pg1</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">R_mol</span><span class="p">:</span> <span class="mf">8.314</span><span class="p">,</span> <span class="n">T_g</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="n">n_g</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">V_g</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 2 µs, sys: 1 µs, total: 3 µs
Wall time: 7.15 µs
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_g = 249.42$$</div></div>
</div>
<p>There is actually no difference!</p>
</div>
<div class="section" id="Empirical-equations-with-internal-variables">
<h3>Empirical equations with internal variables<a class="headerlink" href="#Empirical-equations-with-internal-variables" title="Permalink to this headline">¶</a></h3>
<p>Empirical equations not only contain variables but also numbers. As an example, we will try to define the Clausius-Clapeyron equation for saturation vapour pressure in the following example, after defining a few additional variables used in this equation.</p>
<div class="math notranslate nohighlight">
\[P_{wa} = 611 e^\frac{-M_w \lambda_E (1/T_g - 1/273)}{R_{mol}}\]</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy.physics.units</span> <span class="kn">import</span> <span class="n">joule</span><span class="p">,</span> <span class="n">kilogram</span>
<span class="k">class</span> <span class="nc">lambda_E</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Latent heat of evaporation.&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">joule</span><span class="o">/</span><span class="n">kilogram</span>
    <span class="n">latex_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">lambda_E&#39;</span>
    <span class="n">default</span> <span class="o">=</span> <span class="mf">2.45e6</span>

<span class="k">class</span> <span class="nc">M_w</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Molar mass of water.&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">kilogram</span><span class="o">/</span><span class="n">mole</span>
    <span class="n">default</span> <span class="o">=</span> <span class="mf">0.018</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:lambda_E&#34; will be overridden by &#34;__main__:&lt;class &#39;__main__.lambda_E&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:M_w&#34; will be overridden by &#34;__main__:&lt;class &#39;__main__.M_w&#39;&gt;&#34;
  instance[expr] = instance
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">exp</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">eq_Pwa_CC</span><span class="p">(</span><span class="n">Equation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clausius-Clapeyron P_wa as function of T_g.</span>

<span class="sd">        \cite[Eq. B3]{hartmann_global_1994}</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_wa</span><span class="p">,</span> <span class="mf">611.</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">M_w</span><span class="o">*</span><span class="n">lambda_E</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">T_g</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="mf">273.</span><span class="p">)</span><span class="o">/</span><span class="n">R_mol</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">exc1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Dimension of &#34;1/T_g&#34; is Dimension(1/temperature), but it should be the same as -0.00366300366300366, i.e. Dimension(1)
</pre></div></div>
</div>
<p>The unit mismatch reported in the error message stems from the fact that the numbers in the empirical equation actually need units. Since the term in the exponent has to be non-dimensional, the units of <code class="docutils literal notranslate"><span class="pre">611</span></code> must be the same as those of <code class="docutils literal notranslate"><span class="pre">P_wa</span></code>, i.e. pascal. The units of the subtraction term in the exponent must match, meaning that <code class="docutils literal notranslate"><span class="pre">273</span></code> needs units of kelvin. To avoid the error message, we can define the empirical numbers as internal variables to the equation we want to define:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">eq_Pwa_CC</span><span class="p">(</span><span class="n">Equation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clausius-Clapeyron P_wa as function of T_g.</span>

<span class="sd">    Eq. B3 in :cite{hartmann_global_1994}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">p_CC1</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal parameter of eq_Pwl.&quot;&quot;&quot;</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">pascal</span>
        <span class="n">latex_name</span> <span class="o">=</span> <span class="s1">&#39;611&#39;</span>
        <span class="n">default</span> <span class="o">=</span> <span class="mf">611.</span>



    <span class="k">class</span> <span class="nc">p_CC2</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal parameter of eq_Pwl.&quot;&quot;&quot;</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">kelvin</span>
        <span class="n">latex_name</span> <span class="o">=</span> <span class="s1">&#39;273&#39;</span>
        <span class="n">default</span> <span class="o">=</span> <span class="mf">273.</span>

    <span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_wa</span><span class="p">,</span> <span class="n">p_CC1</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">M_w</span><span class="o">*</span><span class="n">lambda_E</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">T_g</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">p_CC2</span><span class="p">)</span><span class="o">/</span><span class="n">R_mol</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>In the above, we defined the latex representation of the empirical constants as their actual values, so the equation displays in the familiar way:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">eq_Pwa_CC</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_{wa} = 611 e^{- \frac{M_w \lambda_E \left(- \frac{1}{273} + \frac{1}{T_g}\right)}{R_{mol}}}$$</div></div>
</div>
<p>All default values of variables defined along with the variable definitions are stored in a dictionary that can be accessed as <code class="docutils literal notranslate"><span class="pre">Variable.__defaults__</span></code>. We can substitute the values from this dictionary into our empirical equation to plot saturation vapour pressure as a function of temperature:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">expr</span> <span class="o">=</span> <span class="n">eq_Pwa_CC</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<span class="n">xvar</span> <span class="o">=</span> <span class="n">T_g</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">plot_expr2</span><span class="p">((</span><span class="n">xvar</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">373</span><span class="p">),</span> <span class="n">expr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Eq(P_wa, 167405731976.232*exp(-5304.00487246815/T_g))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_api_features_64_1.png" src="../_images/examples_api_features_64_1.png" />
</div>
</div>
</div>
<div class="section" id="Piecewise-defined-equations">
<h3>Piecewise defined equations<a class="headerlink" href="#Piecewise-defined-equations" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Piecewise</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_wa</span><span class="p">,</span> <span class="n">Piecewise</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">T_a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">eq_Pwa_CC</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">T_a</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)))</span>
<span class="n">expr</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_{wa} = \begin{cases} 0 &amp; \text{for}\: T_a &lt; 0 \\611 e^{- \frac{M_w \lambda_E \left(- \frac{1}{273} + \frac{1}{T_g}\right)}{R_{mol}}} &amp; \text{otherwise} \end{cases}$$</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">eq1</span><span class="p">(</span><span class="n">Equation</span><span class="p">):</span>
         <span class="sd">&quot;&quot;&quot;Test&quot;&quot;&quot;</span>
         <span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_wa</span><span class="p">,</span> <span class="n">Piecewise</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">T_a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">eq_Pwa_CC</span><span class="o">.</span><span class="n">rhs</span><span class="p">,</span> <span class="n">T_a</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="n">display</span><span class="p">(</span><span class="n">eq1</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_{wa} = \begin{cases} 0 &amp; \text{for}\: T_a &lt; 0 \\611 e^{- \frac{M_w \lambda_E \left(- \frac{1}{273} + \frac{1}{T_g}\right)}{R_{mol}}} &amp; \text{otherwise} \end{cases}$$</div></div>
</div>
<p><strong>If the above returns a dimension error, then unit checking for ``Piecewise`` has not been implemented yet.</strong></p>
</div>
</div>
<div class="section" id="Substituting-into-integrals-and-derivatives-and-evaluating">
<h2>Substituting into integrals and derivatives and evaluating<a class="headerlink" href="#Substituting-into-integrals-and-derivatives-and-evaluating" title="Permalink to this headline">¶</a></h2>
<p>Above, we defined <code class="docutils literal notranslate"><span class="pre">Delta_Pwa</span></code> as a variable that represents the partial derivative of <code class="docutils literal notranslate"><span class="pre">P_wa</span></code> with respect to <code class="docutils literal notranslate"><span class="pre">T_g</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Delta_Pwa</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Slope of saturated vapour pressure, $\partial P_{ws} / \partial T_g&quot;&quot;&quot;</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">P_wa</span><span class="p">(</span><span class="n">T_g</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">T_g</span><span class="p">)</span>
    <span class="c1">#unit = pascal/kelvin</span>
    <span class="n">latex_name</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\Delta&#39;</span>
</pre></div>
</div>
<p>This definition can be accessed by typing <code class="docutils literal notranslate"><span class="pre">Delta_Pwa.definition.expr</span></code>. Example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">Delta_Pwa</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Eq</span><span class="p">(</span><span class="n">Delta_Pwa</span><span class="p">,</span> <span class="n">Delta_Pwa</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">expr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Derivative(P_wa, T_g)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$\Delta = \frac{d}{d T_g} P_{wa}$$</div></div>
</div>
<p>We also defined the Clausius-Clapeyron approximation to <span class="math notranslate nohighlight">\(P_{wa}(T_g)\)</span> as <code class="docutils literal notranslate"><span class="pre">eq_Pwa_CC</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">display</span><span class="p">(</span><span class="n">eq_Pwa_CC</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">eq_Pwa_CC</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_{wa} = 611 e^{- \frac{M_w \lambda_E \left(- \frac{1}{273} + \frac{1}{T_g}\right)}{R_{mol}}}$$</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Clausius-Clapeyron P_wa as function of T_g.

    Eq. B3 in :cite{hartmann_global_1994}

</pre></div></div>
</div>
<p>If we want to substitute this approximation into <code class="docutils literal notranslate"><span class="pre">Delta_Pwa.definition.expr</span></code>, we need to use <code class="docutils literal notranslate"><span class="pre">replace</span></code> instead of <code class="docutils literal notranslate"><span class="pre">subs</span></code> and evaluate the derivative using <code class="docutils literal notranslate"><span class="pre">doit()</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">Delta_Pwa</span><span class="p">,</span> <span class="n">Delta_Pwa</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">P_wa</span><span class="p">,</span> <span class="n">eq_Pwa_CC</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span><span class="o">.</span><span class="n">doit</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">plot_expr2</span><span class="p">((</span><span class="n">T_g</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">373</span><span class="p">),</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$\Delta = \frac{M_w \lambda_E 611 e^{- \frac{M_w \lambda_E \left(- \frac{1}{273} + \frac{1}{T_g}\right)}{R_{mol}}}}{R_{mol} T_g^{2}}$$</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_api_features_74_1.png" src="../_images/examples_api_features_74_1.png" />
</div>
</div>
<p>If we only had the slope of the curve, we could take the integral to get the absolute value:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Integral</span>
<span class="k">class</span> <span class="nc">T_a1</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Air temperature&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">kelvin</span>
    <span class="n">latex_name</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;T_</span><span class="si">{a1}</span><span class="s1">&#39;</span>

<span class="k">class</span> <span class="nc">T_a2</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Air temperature&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">kelvin</span>
    <span class="n">latex_name</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;T_</span><span class="si">{a2}</span><span class="s1">&#39;</span>

<span class="k">class</span> <span class="nc">P_wa1</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;P_wa at T1&quot;&quot;&quot;</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">pascal</span>
    <span class="n">latex_name</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;P_</span><span class="si">{wa1}</span><span class="s1">&#39;</span>

<span class="k">class</span> <span class="nc">eq_Pwa_Delta</span><span class="p">(</span><span class="n">Equation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;P_wa deduced from the integral of Delta&quot;&quot;&quot;</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_wa</span><span class="p">,</span> <span class="n">P_wa1</span> <span class="o">+</span> <span class="n">Integral</span><span class="p">(</span><span class="n">Delta_Pwa</span><span class="p">,</span> <span class="p">(</span><span class="n">T_g</span><span class="p">,</span> <span class="n">T_a1</span><span class="p">,</span> <span class="n">T_a2</span><span class="p">)))</span>
<span class="n">display</span><span class="p">(</span><span class="n">eq_Pwa_Delta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_{wa} = P_{wa1} + \int_{T_{a1}}^{T_{a2}} \Delta\, dT_g$$</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">expr_Delta</span> <span class="o">=</span> <span class="n">eq_Pwa_CC</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">T_g</span><span class="p">)</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">Eq</span><span class="p">(</span><span class="n">P_wa</span><span class="p">,</span> <span class="n">eq_Pwa_Delta</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">Delta_Pwa</span><span class="p">,</span> <span class="n">expr_Delta</span><span class="p">)</span><span class="o">.</span><span class="n">doit</span><span class="p">())</span>
<span class="n">vdict</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">vdict</span><span class="p">[</span><span class="n">T_a1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">273.</span>
<span class="n">vdict</span><span class="p">[</span><span class="n">P_wa1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq_Pwa_CC</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">T_g</span><span class="p">,</span> <span class="n">T_a1</span><span class="p">)</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">vdict</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">vdict</span><span class="p">))</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">plot_expr2</span><span class="p">((</span><span class="n">T_a2</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">373</span><span class="p">),</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">vdict</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$P_{wa} = 167405731976.232 e^{- \frac{5304.00487246815}{T_{a2}}}$$</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_api_features_77_1.png" src="../_images/examples_api_features_77_1.png" />
</div>
</div>
</div>
<div class="section" id="Unit-conversions">
<h2>Unit conversions<a class="headerlink" href="#Unit-conversions" title="Permalink to this headline">¶</a></h2>
<p>Values for variables are often given in obscure units, but to convert to our standard units, we can use the dictionary <code class="docutils literal notranslate"><span class="pre">SI_EXTENDED_DIMENSIONS</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy.physics.units</span> <span class="kn">import</span> <span class="n">convert_to</span><span class="p">,</span> <span class="n">kilo</span><span class="p">,</span> <span class="n">mega</span><span class="p">,</span> <span class="n">joule</span><span class="p">,</span> <span class="n">kilogram</span><span class="p">,</span> <span class="n">meter</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">inch</span><span class="p">,</span> <span class="n">hour</span>
<span class="kn">from</span> <span class="nn">essm.variables.units</span> <span class="kn">import</span> <span class="n">SI_EXTENDED_DIMENSIONS</span><span class="p">,</span> <span class="n">SI_EXTENDED_UNITS</span>
<span class="n">value1</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">unit1</span> <span class="o">=</span> <span class="n">inch</span><span class="o">/</span><span class="n">hour</span>
<span class="nb">print</span><span class="p">(</span><span class="n">value1</span><span class="o">*</span><span class="n">unit1</span><span class="p">)</span>
<span class="n">unit2</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="n">get_dimensional_expr</span><span class="p">(</span><span class="n">unit1</span><span class="p">)</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">SI_EXTENDED_DIMENSIONS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">convert_to</span><span class="p">(</span><span class="n">value1</span><span class="o">*</span><span class="n">unit1</span><span class="p">,</span> <span class="n">unit2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.3*inch/hour
2.11666666666667e-6*m/s
</pre></div></div>
</div>
</div>
<div class="section" id="Exporting-definitions">
<h2>Exporting definitions<a class="headerlink" href="#Exporting-definitions" title="Permalink to this headline">¶</a></h2>
<p>The below example exports all relevant definitions from this jupyter notebook into a file called <code class="docutils literal notranslate"><span class="pre">test_definitions.py</span></code>, from which they can be re-imported into a different notebook just by executing <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">test_definitions</span> <span class="pre">import</span> <span class="pre">*</span></code>, as shown below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">preorder_traversal</span>
<span class="k">def</span> <span class="nf">extract_units</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Traverse through expression and return set of units.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">arg</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">preorder_traversal</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test_definitions.py&#39;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file1</span><span class="p">:</span>
    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;from essm.variables._core import BaseVariable, Variable</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;from essm.equations import Equation</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;from sympy import (Abs, Derivative, Eq, exp,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;                   Integral, log, Piecewise, sqrt)&#39;</span><span class="p">)</span>
    <span class="c1"># Create import strings for all units</span>
    <span class="n">StrPrinter</span><span class="o">.</span><span class="n">_print_Quantity</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>    <span class="c1"># displays long units (meter instead of m)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">Variable</span><span class="o">.</span><span class="n">__units__</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">extract_units</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">commandstr</span> <span class="o">=</span> <span class="s1">&#39;from sympy.physics.units import &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">commandstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">Variable</span><span class="o">.</span><span class="n">__registry__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">latex_name</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">name</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">assumptions</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">assumptions</span>
        <span class="n">latex_name</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">latex_name</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="n">__expressions__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">default</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Variable class line</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;class </span><span class="si">{0}</span><span class="s1">(Variable):</span><span class="se">\n</span><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span><span class="p">)</span>

        <span class="c1"># doc line</span>
        <span class="n">str_list</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;    &quot;&quot;&quot;&#39;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">str_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_line</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">77</span><span class="p">:</span>
                <span class="n">str_line</span> <span class="o">=</span> <span class="n">str_line</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span> <span class="o">+</span> <span class="n">item</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;    &quot;&quot;&quot;&#39;</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># name line</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s2">&quot;    name = &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># unit line</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;    unit = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># assumptions line</span>
        <span class="n">str_list</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">assumptions</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;    assumptions = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">str_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_line</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">77</span><span class="p">:</span>
                <span class="n">str_line</span> <span class="o">=</span> <span class="n">str_line</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span> <span class="o">+</span> <span class="n">item</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># latex_name</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s2">&quot;    latex_name = r&#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">latex_name</span><span class="p">)</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_equation</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">file1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes equation definition to file.&quot;&quot;&quot;</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get_parents</span><span class="p">(</span><span class="n">eq</span><span class="p">))</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">name</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="n">equ</span> <span class="o">=</span> <span class="n">eq</span>

        <span class="c1"># Equation class line</span>
        <span class="k">if</span> <span class="n">parents</span> <span class="o">==</span> <span class="p">():</span>
            <span class="n">str_parents</span> <span class="o">=</span> <span class="s1">&#39;(Equation&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">str_parents</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.definition&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">str_parents</span> <span class="o">=</span> <span class="n">str_parents</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;.definition&#39;</span>
        <span class="n">str_parents</span> <span class="o">=</span> <span class="n">str_parents</span> <span class="o">+</span> <span class="s1">&#39;):&#39;</span>
        <span class="n">str_list</span> <span class="o">=</span> <span class="n">str_parents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;class </span><span class="si">{0}{1}</span><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">str_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">str_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_line</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">77</span><span class="p">:</span>
                    <span class="n">str_line</span> <span class="o">=</span> <span class="n">str_line</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">item</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;,  # nopep8</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span> <span class="o">+</span> <span class="n">item</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># doc line</span>
        <span class="n">str_list</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="p">)</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;    &quot;&quot;&quot;&#39;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">str_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_line</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">79</span><span class="p">:</span>
                <span class="n">str_line</span> <span class="o">=</span> <span class="n">str_line</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span> <span class="o">+</span> <span class="n">item</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;    &quot;&quot;&quot;&#39;</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># expr line</span>
        <span class="n">str_list</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(\*\*|\*|/)&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">equ</span><span class="p">))</span>
        <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;    expr =&#39;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">str_list</span><span class="p">:</span>
            <span class="n">str_line</span> <span class="o">=</span> <span class="n">str_line</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">item</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">str_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">]:</span>
                    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span> <span class="o">+</span> <span class="s2">&quot;   # nopep8</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">str_line</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_line</span><span class="p">)</span>

    <span class="n">eqs_with_deps</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">Equation</span><span class="o">.</span><span class="n">__registry__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get_parents</span><span class="p">(</span><span class="n">eq</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">parents</span> <span class="o">==</span> <span class="p">():</span>
            <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">write_equation</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">file1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eqs_with_deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span> <span class="c1"># Equations with dependencies must be at the end</span>

    <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">eqs_with_deps</span><span class="p">:</span>
        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">write_equation</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">file1</span><span class="p">)</span>
    <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">StrPrinter</span><span class="o">.</span><span class="n">_print_Quantity</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">abbrev</span><span class="p">)</span>    <span class="c1"># displays short units (m instead of meter)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">test_definitions</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:alpha_a&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.alpha_a&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:c_pa&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.c_pa&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:c_pamol&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.c_pamol&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:c_pv&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.c_pv&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:C_wa&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.C_wa&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:D_va&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.D_va&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:g&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.g&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:Gr&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.Gr&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:h_c&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.h_c&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:k_a&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.k_a&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:lambda_E&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.lambda_E&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:Le&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.Le&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:M_air&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.M_air&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:M_N2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.M_N2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:M_O2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.M_O2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:M_w&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.M_w&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:nu_a&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.nu_a&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:Nu&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.Nu&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:P_a&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.P_a&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:Pr&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.Pr&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:P_N2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.P_N2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:P_O2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.P_O2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:P_wa&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.P_wa&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:P_was&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.P_was&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:R_d&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.R_d&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:Re_c&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.Re_c&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:Re&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.Re&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:rho_a&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.rho_a&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:R_u&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.R_u&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:R_mol&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.R_mol&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:R_s&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.R_s&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:sigm&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.sigm&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:T0&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.T0&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:T_a&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.T_a&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:v_w&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.v_w&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:x_N2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.x_N2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.variables.physics.thermodynamics:x_O2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.x_O2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.equations.physics.thermodynamics:p_Dva1&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.p_Dva1&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.equations.physics.thermodynamics:p_Dva2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.p_Dva2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.equations.physics.thermodynamics:p_alpha1&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.p_alpha1&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.equations.physics.thermodynamics:p_alpha2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.p_alpha2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.equations.physics.thermodynamics:p_ka1&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.p_ka1&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.equations.physics.thermodynamics:p_ka2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.p_ka2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.equations.physics.thermodynamics:p_nua1&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.p_nua1&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;essm.equations.physics.thermodynamics:p_nua2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.p_nua2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:P_g&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.P_g&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:V_g&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.V_g&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:n_g&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.n_g&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:n_w&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.n_w&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:T_g&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.T_g&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:Delta_Pwa&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.Delta_Pwa&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:x&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.x&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:p_CC1&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.p_CC1&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:p_CC2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.p_CC2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:T_a1&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.T_a1&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:T_a2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.T_a2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/variables/_core.py:89: UserWarning: &#34;__main__:P_wa1&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.P_wa1&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_Le&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_Le&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_Cwa&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_Cwa&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_Nu_forced_all&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_Nu_forced_all&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_Dva&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_Dva&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_alphaa&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_alphaa&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_ka&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_ka&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_nua&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_nua&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_rhoa_Pwa_Ta&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_rhoa_Pwa_Ta&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_Pa&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_Pa&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_PN2_PO2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_PN2_PO2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;__main__:eq_ideal_gas_law&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_ideal_gas_law&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;__main__:eq_Pwa_CC&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_Pwa_CC&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;__main__:eq1&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq1&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;__main__:eq_Pwa_Delta&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_Pwa_Delta&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_PO2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_PO2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_PN2&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_PN2&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;essm.equations.physics.thermodynamics:eq_rhoa&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_rhoa&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;__main__:eq_Pg1&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_Pg&#39;&gt;&#34;
  instance[expr] = instance
/home/stan/Programs/essm/essm/equations/_core.py:107: UserWarning: &#34;__main__:eq_Pwa_nw&#34; will be overridden by &#34;test_definitions:&lt;class &#39;test_definitions.eq_Pwa_nw&#39;&gt;&#34;
  instance[expr] = instance
</pre></div></div>
</div>
<p>Since we re-imported names that already had definitions associated with them, we got a warning for each of them before it was overwritten. This tells us that the same variable used before may now have a different meaning, which could introduce inconsistency in the notebook. Here, however, we know that they are all the same.</p>
</div>
<div class="section" id="Numerical-evaluations">
<h2>Numerical evaluations<a class="headerlink" href="#Numerical-evaluations" title="Permalink to this headline">¶</a></h2>
<p>See here for detailed instructions on how to turn sympy expressions into code: <a class="reference external" href="https://docs.sympy.org/latest/modules/codegen.html">https://docs.sympy.org/latest/modules/codegen.html</a></p>
<p>We will first list all equations defined in this worksheet:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">Equation</span><span class="o">.</span><span class="n">__registry__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">eq</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">eq</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
eq_Le: Eq(Le, alpha_a/D_va)
eq_Cwa: Eq(C_wa, P_wa/(R_mol*T_a))
eq_Nu_forced_all: Eq(Nu, -Pr**(1/3)*(-37*Re**(4/5) + 37*(Re + Re_c - Abs(Re - Re_c)/2)**(4/5) - 664*sqrt(Re + Re_c - Abs(Re - Re_c)/2))/1000)
eq_Dva: Eq(D_va, T_a*p_Dva1 - p_Dva2)
eq_alphaa: Eq(alpha_a, T_a*p_alpha1 - p_alpha2)
eq_ka: Eq(k_a, T_a*p_ka1 + p_ka2)
eq_nua: Eq(nu_a, T_a*p_nua1 - p_nua2)
eq_rhoa_Pwa_Ta: Eq(rho_a, (M_N2*P_N2 + M_O2*P_O2 + M_w*P_wa)/(R_mol*T_a))
eq_Pa: Eq(P_a, P_N2 + P_O2 + P_wa)
eq_PN2_PO2: Eq(P_N2, P_O2*x_N2/x_O2)
eq_PO2: Eq(P_O2, (P_a*x_O2 - P_wa*x_O2)/(x_N2 + x_O2))
eq_PN2: Eq(P_N2, (P_a*x_N2 - P_wa*x_N2)/(x_N2 + x_O2))
eq_rhoa: Eq(rho_a, (x_N2*(M_N2*P_a - P_wa*(M_N2 - M_w)) + x_O2*(M_O2*P_a - P_wa*(M_O2 - M_w)))/(R_mol*T_a*x_N2 + R_mol*T_a*x_O2))
eq_ideal_gas_law: Eq(P_g*V_g, R_mol*T_g*n_g)
eq_Pg: Eq(P_g, R_mol*T_g*n_g/V_g)
eq_Pwa_nw: Eq(P_wa, R_mol*T_g*n_w/V_g)
eq_Pwa_CC: Eq(P_wa, p_CC1*exp(-M_w*lambda_E*(-1/p_CC2 + 1/T_g)/R_mol))
eq1: Eq(P_wa, Piecewise((0, T_a &lt; 0), (p_CC1*exp(-M_w*lambda_E*(-1/p_CC2 + 1/T_g)/R_mol), True)))
eq_Pwa_Delta: Eq(P_wa, P_wa1 + Integral(Delta_Pwa, (T_g, T_a1, T_a2)))
</pre></div></div>
</div>
<div class="section" id="Substitution-of-equations-and-values-into-equations">
<h3>Substitution of equations and values into equations<a class="headerlink" href="#Substitution-of-equations-and-values-into-equations" title="Permalink to this headline">¶</a></h3>
<p>The easiest way is to define a dictionary with all variables we want to substitute as keys. We start with the default variables and then add more. First, however, we will define a function to display the contents of a dictionary:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">print_dict</span><span class="p">(</span><span class="n">vdict</span><span class="p">,</span> <span class="n">list_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print values and units of variables in vdict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">list_vars</span><span class="p">:</span>
        <span class="n">list_vars</span> <span class="o">=</span> <span class="n">vdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">var1</span> <span class="ow">in</span> <span class="n">list_vars</span><span class="p">:</span>
        <span class="n">unit1</span> <span class="o">=</span> <span class="n">var1</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">if</span> <span class="n">unit1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">unit1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">vdict</span><span class="p">[</span><span class="n">var1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vdict</span><span class="p">[</span><span class="n">var1</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">unit1</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">vdict</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">print_dict</span><span class="p">(</span><span class="n">vdict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
c_pa: 1010.0 J/(K*kg)
c_pamol: 29.19 J/(K*mol)
c_pv: 1864 J/(K*kg)
g: 9.81 m/s**2
lambda_E: 2450000.0 J/kg
M_air: 0.02897 kg/mol
M_N2: 0.028 kg/mol
M_O2: 0.032 kg/mol
M_w: 0.018 kg/mol
R_mol: 8.314472 J/(K*mol)
sigm: 5.67e-08 J/(K**4*m**2*s)
T0: 273.15 K
x_N2: 0.79
x_O2: 0.21
p_Dva1: 1.49e-07 m**2/(K*s)
p_Dva2: 1.96e-05 m**2/s
p_alpha1: 1.32e-07 m**2/(K*s)
p_alpha2: 1.73e-05 m**2/s
p_ka1: 6.84e-05 J/(K**2*m*s)
p_ka2: 0.00563 J/(K*m*s)
p_nua1: 9e-08 m**2/(K*s)
p_nua2: 1.13e-05 m**2/s
p_CC1: 611.0 Pa
p_CC2: 273.0 K
</pre></div></div>
</div>
<p>We can substitute a range of equations into each other by using the custom function <code class="docutils literal notranslate"><span class="pre">subs_eq</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">essm.variables.utils</span> <span class="kn">import</span> <span class="n">subs_eq</span>
<span class="n">subs_eq</span><span class="p">(</span><span class="n">eq_Le</span><span class="p">,</span> <span class="p">[</span><span class="n">eq_alphaa</span><span class="p">,</span> <span class="n">eq_Dva</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$N_{Le} = \frac{T_a p_1 - p_2}{T_a p_1 - p_2}$$</div></div>
</div>
<p>We can also use subs_eq to substitute equations into each other and a dictionary with values. We will first add an entry for T_a into the dictionary and then substitute:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">vdict</span><span class="p">[</span><span class="n">T_a</span><span class="p">]</span> <span class="o">=</span> <span class="mf">300.</span>
<span class="n">subs_eq</span><span class="p">(</span><span class="n">eq_Le</span><span class="p">,</span> <span class="p">[</span><span class="n">eq_alphaa</span><span class="p">,</span> <span class="n">eq_Dva</span><span class="p">],</span> <span class="n">vdict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$N_{Le} = 0.888446215139442$$</div></div>
</div>
</div>
<div class="section" id="Evaluation-of-equations-for-long-lists-of-variable-sets">
<h3>Evaluation of equations for long lists of variable sets<a class="headerlink" href="#Evaluation-of-equations-for-long-lists-of-variable-sets" title="Permalink to this headline">¶</a></h3>
<p>Substitution of variables into equations takes a lot of time if they need to be evaluated for a large number of variables. We can use theano to speed this up:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#import theano</span>
<span class="kn">from</span> <span class="nn">sympy.printing.theanocode</span> <span class="kn">import</span> <span class="n">theano_function</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING (theano.tensor.blas): Using NumPy C-API based implementation for BLAS functions.
</pre></div></div>
</div>
<p>We will now create two long lists of values representing T_g and n_g respectively and show how long it takes to compute ideal gas law values.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">npoints</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="mf">290.</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="mf">310.</span>
<span class="n">Tvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">npoints</span><span class="p">)</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">nvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">npoints</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="c1"># looping</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">eq_ideal_gas_law</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">)</span>
<span class="n">resvals0</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tvals</span><span class="p">)):</span>
    <span class="n">resvals0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">T_g</span><span class="p">:</span> <span class="n">Tvals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">n_g</span><span class="p">:</span> <span class="n">nvals</span><span class="p">[</span><span class="n">i</span><span class="p">]}))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 6.73 s, sys: 8.6 ms, total: 6.74 s
Wall time: 6.74 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="c1"># Using theano</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">theano_function</span><span class="p">([</span><span class="n">T_g</span><span class="p">,</span> <span class="n">n_g</span><span class="p">],</span> <span class="p">[</span><span class="n">eq_ideal_gas_law</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">)],</span> <span class="n">dims</span><span class="o">=</span><span class="p">{</span><span class="n">T_g</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_g</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
<span class="n">resvals1</span> <span class="o">=</span> <span class="n">f1</span><span class="p">(</span><span class="n">Tvals</span><span class="p">,</span><span class="n">nvals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 47.5 ms, sys: 14.6 ms, total: 62.1 ms
Wall time: 724 ms
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">list</span><span class="p">(</span><span class="n">resvals0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">resvals1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p><strong>Both approaches give identical results, but ``theano_function`` makes it a lot faster.</strong></p>
</div>
<div class="section" id="Numerical-solution">
<h3>Numerical solution<a class="headerlink" href="#Numerical-solution" title="Permalink to this headline">¶</a></h3>
<p>Some equations cannot be solved analytically for a given variable, e.g. eq_Nu_forced_all cannot be solved analytically for Re if Nu is given, so we can use numerical solvers instead:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">nsolve</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">vdict</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">vdict</span><span class="p">[</span><span class="n">Pr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.71</span>
<span class="n">vdict</span><span class="p">[</span><span class="n">Re_c</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3000.</span>
<span class="n">vdict</span><span class="p">[</span><span class="n">Nu</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">eq_Nu_forced_all</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">vdict</span><span class="p">)</span>
<span class="n">nsolve</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$690263.0346446$$</div></div>
</div>
<p>Now applying to a long list of Nu-values:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">npoints</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="mf">1200.</span>
<span class="n">Nuvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">npoints</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="c1"># Solving for a range of Nu values</span>
<span class="n">vdict</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">vdict</span><span class="p">[</span><span class="n">Pr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.71</span>
<span class="n">vdict</span><span class="p">[</span><span class="n">Re_c</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3000.</span>
<span class="n">resvals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">Nu1</span> <span class="ow">in</span> <span class="n">Nuvals</span><span class="p">:</span>
    <span class="n">vdict</span><span class="p">[</span><span class="n">Nu</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nu1</span>
    <span class="n">resvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nsolve</span><span class="p">(</span><span class="n">eq_Nu_forced_all</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">vdict</span><span class="p">),</span> <span class="mf">1000.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.84 s, sys: 10.3 ms, total: 1.85 s
Wall time: 1.85 s
</pre></div></div>
</div>
<p>We will now again use a theano function to make it faster. First we import optimize from scipy and preapre the theano_function:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">sciopt</span>
<span class="n">vdict</span> <span class="o">=</span> <span class="n">Variable</span><span class="o">.</span><span class="vm">__defaults__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">vdict</span><span class="p">[</span><span class="n">Pr</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.71</span>
<span class="n">vdict</span><span class="p">[</span><span class="n">Re_c</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3000.</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">eq_Nu_forced_all</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">vdict</span><span class="p">)</span>
<span class="n">expr1</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rhs</span> <span class="o">-</span> <span class="n">expr</span><span class="o">.</span><span class="n">lhs</span>
<span class="n">fun_tf</span> <span class="o">=</span> <span class="n">theano_function</span><span class="p">([</span><span class="n">Re</span><span class="p">,</span> <span class="n">Nu</span><span class="p">],</span> <span class="p">[</span><span class="n">expr1</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">{</span><span class="n">Nu</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">Re</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
<span class="n">x0vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">Nuvals</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">2000.</span><span class="p">)</span> <span class="c1"># array of same shape as Nuvals, with initial guess</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="c1"># Solving for a range of Nu values</span>
<span class="n">resvals1</span> <span class="o">=</span> <span class="n">sciopt</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">fun_tf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">Nuvals</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0vals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 7.57 ms, sys: 0 ns, total: 7.57 ms
Wall time: 7.72 ms
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">resvals</span> <span class="o">-</span> <span class="n">resvals1</span><span class="p">)</span><span class="o">/</span><span class="n">resvals</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$5.35695853236626 \cdot 10^{-11}$$</div></div>
</div>
<p><strong>Using theano and scipy makes it 2 orders of magnitude faster and the results are different only by 10:math:`^{-10}`%!</strong> <strong>Note, however, that scipy gets slowed down for large arrays, so it is more efficient to re-run it repreatedly with subsections of the arra:</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">npoints</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="mf">1200.</span>
<span class="n">Nuvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">npoints</span><span class="p">)</span>
<span class="n">x0vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">Nuvals</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">2000.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="c1"># Solving for a range of Nu values</span>
<span class="n">resvals1</span> <span class="o">=</span> <span class="n">sciopt</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">fun_tf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">Nuvals</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0vals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 2.07 s, sys: 5.18 ms, total: 2.08 s
Wall time: 2.08 s
</pre></div></div>
</div>
<p>We will now test that we can process Nuvals bit by bit and re-create it consistently:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Solving for a range of Nu values</span>
<span class="n">imax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Nuvals</span><span class="p">)</span>
<span class="n">i0</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">idiff</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">i1</span> <span class="o">=</span> <span class="n">i0</span>
<span class="n">resvals2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">while</span> <span class="n">i1</span> <span class="o">&lt;</span> <span class="n">imax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">i0</span> <span class="o">=</span> <span class="n">i1</span>    <span class="c1"># note that resvals[0:2] + resvals[2:4] = resvals[0:4]</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i0</span><span class="o">+</span><span class="n">idiff</span><span class="p">,</span> <span class="n">imax</span><span class="p">)</span>
    <span class="n">resvals0</span> <span class="o">=</span> <span class="n">Nuvals</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
    <span class="n">resvals2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resvals2</span><span class="p">,</span><span class="n">resvals0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">resvals2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">Nuvals</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p>Now we will run fsolve for portions of Nuvals bit by bit:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="c1"># Solving for a range of Nu values</span>
<span class="n">imax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Nuvals</span><span class="p">)</span>
<span class="n">i0</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">idiff</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">i1</span> <span class="o">=</span> <span class="n">i0</span>
<span class="n">resvals2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">while</span> <span class="n">i1</span> <span class="o">&lt;</span> <span class="n">imax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">i0</span> <span class="o">=</span> <span class="n">i1</span>    <span class="c1"># note that resvals[0:2] + resvals[2:4] = resvals[0:4]</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i0</span><span class="o">+</span><span class="n">idiff</span><span class="p">,</span> <span class="n">imax</span><span class="p">)</span>
    <span class="n">resvals0</span> <span class="o">=</span> <span class="n">sciopt</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">fun_tf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">Nuvals</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">],</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0vals</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
    <span class="n">resvals2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resvals2</span><span class="p">,</span><span class="n">resvals0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 74 ms, sys: 464 µs, total: 74.4 ms
Wall time: 75.2 ms
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">resvals1</span> <span class="o">-</span> <span class="n">resvals2</span><span class="p">)</span><span class="o">/</span><span class="n">resvals1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$7.122603685219754e-10$$</div></div>
</div>
<p><strong>It is strange that resvals1 and resvals2 are different at all, but anyway, it is clear that slicing the data in relatively small portions is important to keep ``scipy.optimize.fsolve`` time-efficient.</strong></p>
</div>
<div class="section" id="Generate-code-from-sympy-expressions-and-execute">
<h3>Generate code from sympy expressions and execute<a class="headerlink" href="#Generate-code-from-sympy-expressions-and-execute" title="Permalink to this headline">¶</a></h3>
<p>Need to install gfortran system-wide first!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy.utilities.autowrap</span> <span class="kn">import</span> <span class="n">autowrap</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">symbols</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;x y z&#39;</span><span class="p">)</span>
<span class="n">expr</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
<span class="n">autowrap_func</span> <span class="o">=</span> <span class="n">autowrap</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">autowrap_func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 7 µs, sys: 2 µs, total: 9 µs
Wall time: 13.1 µs
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$-1.0$$</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 76.3 ms, sys: 4.05 ms, total: 80.3 ms
Wall time: 79.7 ms
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$-1$$</div></div>
</div>
<p>Use of <code class="docutils literal notranslate"><span class="pre">autowrap</span></code> made the calculation 3 orders of magnitude faster than substitution of values into the original expression!</p>
<p>Another way is to use <code class="docutils literal notranslate"><span class="pre">binary_function</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sympy.utilities.autowrap</span> <span class="kn">import</span> <span class="n">binary_function</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">binary_function</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">evalf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">subs</span><span class="o">=</span><span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.15 ms, sys: 287 µs, total: 1.44 ms
Wall time: 1.45 ms
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$$-1.0$$</div></div>
</div>
<p>However, for the above example, <code class="docutils literal notranslate"><span class="pre">binary_function</span></code> was 10 times slower than <code class="docutils literal notranslate"><span class="pre">autowrap</span></code>.</p>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Python package for dealing with physical variables and units.</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="importable_variables_equations.html">Importable variables and equations</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Use examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Importing-variables-and-equations-from-essm">Importing variables and equations from essm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Plotting">Plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Creating-new-variables">Creating new variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Variables-with-expressions-as-definitions">Variables with expressions as definitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Linking-assumptions-to-variables">Linking assumptions to variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Creating-new-equations">Creating new equations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Custom-equation">Custom equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#New-equation-based-on-manipulation-of-previous-equations">New equation based on manipulation of previous equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Show-inheritance-of-equations">Show inheritance of equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Computational-burden-of-deriving-equations-within-class-definition">Computational burden of deriving equations within class definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Empirical-equations-with-internal-variables">Empirical equations with internal variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Piecewise-defined-equations">Piecewise defined equations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Substituting-into-integrals-and-derivatives-and-evaluating">Substituting into integrals and derivatives and evaluating</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Unit-conversions">Unit conversions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Exporting-definitions">Exporting definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Numerical-evaluations">Numerical evaluations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Substitution-of-equations-and-values-into-equations">Substitution of equations and values into equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Evaluation-of-equations-for-long-lists-of-variable-sets">Evaluation of equations for long lists of variable sets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Numerical-solution">Numerical solution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Generate-code-from-sympy-expressions-and-execute">Generate code from sympy expressions and execute</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changes.html">Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Authors</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://github.com/environmentalscience/essm">essm@GitHub</a></li>
    
    <li class="toctree-l1"><a href="https://pypi.python.org/pypi/essm/">essm@PyPI</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="importable_variables_equations.html" title="previous chapter">Importable variables and equations</a></li>
      <li>Next: <a href="../api.html" title="next chapter">API Docs</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Stan Schymanski.
      
      |
      <a href="../_sources/examples/api_features.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/environmentalscience/essm" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>